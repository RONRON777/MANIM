# MANIM

고객의 개인정보와 가입한 보험 내용을 관리하는 GUI 프로그램입니다.  
사용자는 고객 정보를 입력하고, 고객이 가입한 보험 정보를 등록한 뒤 필요할 때 언제든 조회할 수 있습니다.  
등록된 정보는 수정 및 제거가 가능하며, 모든 데이터는 로컬 암호화 DB에 저장됩니다.

## 주요 기능

- 고객 개인정보 추가
- 고객 정보 CSV 일괄 추가
- 고객 개인정보 조회
- 고객 개인정보 수정
- 고객 개인정보 제거
- 고객별 보험 가입 정보 추가
- 고객별 보험 가입 정보 조회
- 고객별 보험 가입 정보 수정
- 고객별 보험 가입 정보 제거
- 조회/추가/수정/삭제 이력 로그 기록

## 데이터 저장 및 보안

- DB 엔진은 `SQLCipher`를 기본으로 사용합니다.
- 민감정보(`주민번호`, `카드번호`, `결제계좌`, `보험금 수령계좌`)는 애플리케이션 레벨에서
  `AES-256-GCM`으로 암호화해 저장합니다.
- 암호화 키는 DB와 분리된 환경변수에서 로드합니다.
- 조회 시 민감정보는 기본 마스킹되며, 명시적 요청 시에만 복호화합니다.

## 키 관리 정책

- DB 키: 환경변수 `MANIM_DB_KEY`
- 필드 암호화 키: 환경변수 `MANIM_ENCRYPTION_KEY` (32바이트 base64)
- 설정 파일: `config/security.yaml` (키 값 자체는 저장하지 않음)
- 최초 실행 전 운영자가 키를 생성/주입해야 합니다.
- 키 변경은 데이터 마이그레이션(복호화 후 재암호화) 절차로 수행합니다.

## 로그(감사 이력)

- 다음 동작은 모두 로그로 남깁니다: `조회`, `추가`, `수정`, `삭제`
- 로그에는 최소한 동작 유형, 대상 데이터, 실행 시각을 포함합니다.
- 로그는 추적과 감사 목적의 데이터로 보관합니다.
- 기본 보관 기간은 3년(1095일)이며, 앱 시작 시 만료 로그를 자동 정리합니다.

## 고객 정보 항목

`고객`은 `계약자`를 의미합니다.

- 이름
- 주민번호
- 연락처
- 주소
- 직업
- 결제정보(카드, 계좌)
- 보험금 수령 계좌
- 병력
- 비고

## 보험 정보 항목

- 계약일자
- 보험사
- 증권번호
- 상품명
- 보험료
- 계약자
- 피보험자
- 결제일
- 수익자

## 삭제 정책

- 고객/보험은 기본 `soft delete`(`deleted_at`)를 사용합니다.
- 활성 보험이 남아 있는 고객은 삭제할 수 없습니다.
- FK는 `ON DELETE RESTRICT`로 설정해 의도치 않은 연쇄 삭제를 방지합니다.

## 동시성/성능 정책

- GUI 조회는 `QThreadPool` 백그라운드 작업으로 처리해 UI 멈춤을 방지합니다.
- DB 연결은 `ThreadLocalConnection`으로 스레드별 분리 관리합니다.
- 목록 조회는 `LIMIT/OFFSET` 페이징을 사용합니다.
- 검색/조회를 위한 인덱스를 적용합니다.

## 실행 준비

빠른 실행 스크립트:

```bash
./start.sh
```

`start.sh`는 `setup + keys + app`을 한 번에 처리하며, 실패 시 이유를 한국어로 안내합니다.

Windows에서는 아래를 사용합니다.

```bat
start.bat
```

또는 PowerShell:

```powershell
./start.ps1
```

개발용 명령:

```bash
./run.sh setup
./run.sh keys
export MANIM_DB_KEY='...'
export MANIM_ENCRYPTION_KEY='...'
./run.sh test
./run.sh app
```

수동 실행:

1. 의존성 설치

```bash
pip install -e .[test,sqlcipher]
```

2. 최초 키 생성

```bash
PYTHONPATH=src python3 scripts/generate_keys.py
```

3. 키 설정 (예시)

```bash
export MANIM_DB_KEY='change-this-db-key'
export MANIM_ENCRYPTION_KEY='base64-32-byte-key'
```

4. 실행

```bash
manim-app
```

## 고객 입력 방법

- 수기 입력: GUI 폼에서 항목 입력 후 `고객 추가`
- CSV 입력: GUI에서 `고객 CSV 가져오기` 버튼으로 파일 선택 후 일괄 등록

CSV 헤더는 아래 순서를 권장합니다.

```csv
이름,주민번호,연락처,주소,직업,카드번호,결제계좌,보험금수령계좌,병력,비고
```

## 보험 입력 방법

- 수기 입력: GUI(차기 보험 탭) 또는 내부 서비스 호출
- CSV 입력: GUI에서 `보험 CSV 가져오기` 버튼으로 파일 선택 후 일괄 등록

보험 CSV 헤더는 아래 순서를 사용합니다.

```csv
고객ID,계약일자,보험사,증권번호,상품명,보험료,피보험자,결제일,수익자
```

## 도움말

- 앱의 `도움말` 탭에서 간단 사용법과 CSV 헤더 형식을 바로 확인할 수 있습니다.
